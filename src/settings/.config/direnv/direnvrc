# Usage: layout uv [strategy]
#
# Enables the uv project layout in the current directory, and syncs
# the dependencies in the project based on strategy argument.
#
# Strategies:
#   - update: Always update to the newest dependencies
#   - frozen: (Default) Sync dependencies to uv.lock
#   - no: Don't sync (fastest)
# This relies on the `uv` command being available in the PATH and uv's
# configuration file and environment variables, rather than arguments.
#
layout_uv() {
  local strategy=${1:-frozen}
  local venv_path="$(expand_path "${UV_PROJECT_ENVIRONMENT:-.venv}")"

  # Watch the uv configuration file for changes
  watch_file .python-version pyproject.toml uv.lock

  if [[ ! -f "pyproject.toml" ]]; then
    log_status "No uv project exists. Executing \`uv init --bare\` to create one."
    uv init --bare
  fi
  if [[ ! -d "$venv_path" ]]; then
    log_status "No \"$venv_path\" exists. Executing \`uv venv -c\` to create one."
    uv venv -c "$venv_path"
  fi

  case "$strategy" in
    "update")
      uv sync || true
      ;;
    "frozen")
      uv sync --frozen || true
      ;;
    esac

  # activate the virtualenv after syncing; this puts the newly-installed
  # binaries on PATH.
  if [[ -e "$venv_path" ]]; then
    # shellcheck source=/dev/null
    source "$venv_path/bin/activate"
  fi
}
