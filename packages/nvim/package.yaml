name: nvim
version: 0.11.5
datasource: github-releases
package: neovim/neovim-releases
url: https://github.com/neovim/neovim-releases/releases/download/v{version}/nvim-linux-x86_64.tar.gz
extract: true
checksum_source: github-release
files:
  - src: bin
    dst: .local/bin
  - src: lib
    dst: .local/lib
  - src: share
    dst: .local/share
init_cmds:
  - nvim --headless -c 'Lazy! sync' -c 'Lazy! build nvim-treesitter' +qa
  - nvim --headless -c 'MasonToolsUpdateSync' +qa
  - |
    QUERIES_DIR="$HOME/.local/share/nvim/site/queries"
    if [ -d "$QUERIES_DIR" ]; then
      cd "$QUERIES_DIR" || exit 1
      for link in *; do
        if [ -L "$link" ]; then
          if target=$(realpath --relative-to="$QUERIES_DIR" "$link" 2>/dev/null); then
            if [ -n "$target" ]; then
              # `ln -sf` does not replace absolute path with relative path.
              # Force unlinking the absolute path instead.
              unlink "$link"
              ln -s "$target" "$link"
            fi
          fi
        fi
      done
    fi
subpackages:
  - manifest: tests/nvim/manifest.lua
    manifest_type: lua
    test_defaults:
      type: nvim-plugin
  - manifest: inline
    manifest_type: inline
    test_defaults:
      type: version-check
    packages:
      - name: verible
        bin: verible-verilog-ls
      - name: clangd
test:
  type: cmd
  cmd: nvim --version && nvim --headless -c "PlenaryBustedFile tests/nvim/runner.lua" +qa
