name: Release workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Weekly build every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Commit lint
        uses: wagoid/commitlint-github-action@v6

      - name: Setup just
        uses: extractions/setup-just@v3

      - name: Setup makeself
        uses: henry-hsieh/setup-makeself@v1

      - name: Cache docker images
        id: cache_image
        uses: AndreKurait/docker-cache@0.6.0
        with:
          key: docker-${{ runner.os }}-${{ hashFiles('src/Dockerfile') }}
          read-only: ${{ github.event_name == 'pull_request' }}

      - name: Build docker image
        run: |
          if [[ "$(docker images | grep 'personal-setup')" == "" ]]; then
            just build_docker
          fi

      - name: Restore build cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/personal-setup
          key: personal-setup-${{ hashFiles('packages/**') }}
          restore-keys: |
            personal-setup-

      - name: Build
        id: run_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: just

      - name: Save build cache
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/personal-setup
          key: personal-setup-${{ hashFiles('packages/**') }}

      - name: Upload logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build/logs

      - name: Upload release artifact
        if: steps.run_build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: release-artifact
          path: build/personal-setup.xz.sh

  test:
    name: Test
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest, manager: 'apt', image: 'ubuntu:latest'}
          - { os: ubuntu-latest, manager: 'yum', image: 'oraclelinux:8'}
          - { os: ubuntu-latest, manager: 'apt', image: 'ubuntu:18.04' }
          - { os: ubuntu-latest, manager: 'apt', image: 'ubuntu:20.04' }
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: endersonmenezes/free-disk-space@v2
        with:
          remove_android: true
          remove_dotnet: true
          remove_haskell: true
          remove_tool_cache: true
          remove_swap: true
          remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
          remove_packages_one_command: true
          remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/share/glade* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell"
          testing: false

      - name: Setup just
        uses: extractions/setup-just@v3

      - name: Install dependencies
        run: |
          if [[ "${{ matrix.manager }}" == "apt" ]]; then
            echo "FROM ${{ matrix.image }}" > Dockerfile
            echo "RUN apt update" >> Dockerfile
            echo "RUN apt install -y tcsh curl tar xz-utils make git ca-certificates fuse libatomic1" >> Dockerfile
          elif [[ "${{ matrix.manager }}" == "yum" ]]; then
            echo "FROM ${{ matrix.image }}" > Dockerfile
            echo "RUN yum install -y tcsh curl tar xz make git ca-certificates fuse-libs libatomic" >> Dockerfile
          fi
          echo "RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin/" >> Dockerfile

      - name: Cache docker images
        id: cache_image
        uses: AndreKurait/docker-cache@0.6.0
        with:
          key: docker-${{ runner.os }}-${{ hashFiles('Dockerfile') }}
          read-only: ${{ github.event_name == 'pull_request' }}

      - name: Build docker image
        run: |
          if [[ "$(docker images --format '{{.Repository}}:{{.Tag}}' | grep 'test-${{ matrix.image }}')" == "" ]]; then
            docker build -t test-${{ matrix.image }} .
          fi

      - name: Download release artifact
        id: download_release_artifact
        uses: actions/download-artifact@v4
        with:
          name: release-artifact
          path: build/

      - name: Run tests
        id: run_test
        run: |
          chmod +x build/personal-setup.xz.sh
          docker run -t --privileged -v $(pwd):$(pwd) -w $(pwd) --user $(id -u):$(id -g) test-${{ matrix.image }} bash -c 'just test_clean=1 test'

      - name: Create log name
        if: ${{ always() }}
        run: |
          IMAGE_NAME="${{ matrix.image }}"
          echo "IMAGE_NAME=${IMAGE_NAME/:/_}" >> $GITHUB_ENV

      - name: Upload logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ env.IMAGE_NAME }}
          path: build/logs

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.test.result == 'success'

    steps:
      - name: Get token
        uses: actions/create-github-app-token@v1
        id: get_token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Create release
        id: create_release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ steps.get_token.outputs.token }}
          release-type: simple

      - name: Download release artifact
        id: download_release_artifact
        if: ${{ steps.create_release.outputs.release_created }}
        uses: actions/download-artifact@v4
        with:
          name: release-artifact
          path: build/

      - name: Upload release asset
        if: steps.download_release_artifact.outcome == 'success'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ steps.get_token.outputs.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: build/personal-setup.xz.sh
          asset_name: personal-setup-${{ steps.create_release.outputs.tag_name }}.xz.sh

  nightly-release:
    name: Nightly Release
    runs-on: ubuntu-latest
    needs: test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release artifact
        uses: actions/download-artifact@v4
        with:
          name: release-artifact
          path: build/

      - name: Delete existing nightly release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete nightly --yes --cleanup-tag || true

      - name: Create nightly release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create nightly \
            --title "Nightly Build" \
            --notes "Automated nightly build from the latest main branch.

          **Commit:** ${{ github.sha }}
          **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          > [!WARNING]
          > This is an unstable pre-release build. Use at your own risk." \
            --prerelease \
            --target ${{ github.sha }} \
            build/personal-setup.xz.sh#personal-setup-nightly.xz.sh
